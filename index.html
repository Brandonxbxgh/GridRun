<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no" />
  <title>GRIDRUN</title>

  <!-- Supabase v2 (ONLY ONCE) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bgA:#1a1c30;
      --bgB:#292942;
      --accentA:#ff5733;
      --accentB:#ff8b3d;
      --glass:rgba(0,0,0,0.22);
      --glass2:rgba(0,0,0,0.30);
      --stroke:rgba(255,255,255,0.12);
      --stroke2:rgba(255,255,255,0.18);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.72);
      --muted2:rgba(255,255,255,0.58);
    }

    body{
      margin:0;padding:0;
      font-family:Verdana,sans-serif;
      background:linear-gradient(135deg,var(--bgA),var(--bgB),var(--bgA));
      animation:backgroundMove 10s infinite alternate;
      height:100vh; overflow:hidden; color:white;
    }
    @keyframes backgroundMove {0%{background-position:0% 50%}100%{background-position:100% 50%}}

    #game-container{display:flex;justify-content:center;align-items:center;height:100%;text-align:center;}
    #phaser-container{display:none;width:100%;height:100%;justify-content:center;align-items:center;}
    canvas{display:block;margin:0 auto;}

    h1{font-size:3rem;font-weight:bold;color:#fff;text-shadow:0 0 20px var(--accentA),0 0 30px var(--accentA); margin:0 0 8px 0;}
    p{font-size:18px;margin:10px 0;}
    button{
      margin:8px;padding:15px 30px;font-size:1rem;font-weight:bold;color:white;
      background:linear-gradient(45deg,var(--accentA),var(--accentB));
      border:none;border-radius:50px;cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.4),0 0 15px rgba(255,87,51,.7);
      transition:transform .2s,box-shadow .3s,opacity .2s;
    }
    button:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.4),0 0 25px rgba(255,110,60,1)}
    button:active{transform:translateY(2px);box-shadow:0 2px 5px rgba(0,0,0,.3),0 0 10px rgba(255,79,40,.9)}
    button:disabled{opacity:.35;cursor:not-allowed;filter:grayscale(.25);box-shadow:none;transform:none}

    .menu-screen{
      display:flex;flex-direction:column;align-items:center;gap:10px;
      padding:20px;max-width:560px;width:100%;
    }

    .subhead{
      font-size:14px;
      color:var(--muted);
      margin:0 0 14px 0;
      line-height:1.4;
      max-width:520px;
    }

    .panel{
      width:100%;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 26px rgba(0,0,0,0.28);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .panelTitle strong{
      font-size:14px;
      color:var(--text);
      letter-spacing:0.3px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,0.25);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .pill b{color:#fff; font-weight:700;}

    .toggle-row{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.12);
    }
    .toggle-row span{font-size:14px;opacity:0.95}
    .small-note{font-size:12px;opacity:0.75;max-width:520px;line-height:1.35}

    /* Leaderboards UI */
    .tabs{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      margin:10px 0 12px 0;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(0,0,0,0.28);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      transition:transform .15s, border-color .2s, background .2s, color .2s;
      user-select:none;
    }
    .tab:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,0.22); }
    .tab.active{
      background:linear-gradient(45deg,rgba(255,87,51,0.35),rgba(255,139,61,0.28));
      border-color:rgba(255,140,80,0.55);
      color:#fff;
      box-shadow:0 0 20px rgba(255,110,60,0.25);
    }

    .lbWrap{
      width:100%;
      max-height:52vh;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,0.22);
    }
    .lbHeader, .lbRow{
      display:grid;
      grid-template-columns: 70px 1fr 110px;
      gap:10px;
      align-items:center;
      padding:12px 12px;
    }
    .lbHeader{
      position:sticky;
      top:0;
      z-index:2;
      background:rgba(0,0,0,0.45);
      border-bottom:1px solid rgba(255,255,255,0.10);
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.3px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .lbRow{
      border-bottom:1px solid rgba(255,255,255,0.08);
      font-size:14px;
      color:var(--text);
    }
    .lbRow:last-child{border-bottom:none;}
    .rank{
      font-weight:900;
      color:#fff;
      opacity:0.92;
    }
    .name{
      display:flex;
      align-items:center;
      gap:10px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.10);
      color:var(--muted);
      white-space:nowrap;
    }
    .score{
      text-align:right;
      font-weight:900;
      color:#fff;
      letter-spacing:0.3px;
    }
    .me{
      background:linear-gradient(90deg,rgba(255,87,51,0.16),rgba(0,0,0,0));
      border-left:3px solid rgba(255,87,51,0.65);
    }
    .hint{
      font-size:12px;
      color:var(--muted2);
      line-height:1.4;
      margin-top:10px;
    }

    /* Smooth scroll on iOS */
    .lbWrap{ -webkit-overflow-scrolling: touch; }
  </style>
</head>

<body>
  <div id="game-container"></div>
  <div id="phaser-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <script>
    /***********************
     * SUPABASE GLOBAL CONFIG (SINGLE SOURCE OF TRUTH)
     * - Uses your existing tables:
     *   public.profiles: user_id (uuid PK), username (unique)
     *   public.scores:   id uuid PK, user_id uuid, mode text, score bigint, updated_at timestamptz
     *   UNIQUE (user_id, mode)
     ***********************/
    const SUPABASE_URL = "https://pgoeyzhnrafupqvfrdnn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnb2V5emhucmFmdXBxdmZyZG5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3OTQzNTMsImV4cCI6MjA4MjM3MDM1M30.Nh7Q3VKna6eQcaqRozccFKEaSHIG0t18h6Pw37hQ4i8";

    const MODES = ["endless","campaign","w1","w2","w3"]; // locked

    let sb = null;
    function globalEnabled(){
      return (
        typeof window.supabase !== "undefined" &&
        typeof SUPABASE_URL === "string" &&
        typeof SUPABASE_ANON_KEY === "string" &&
        SUPABASE_URL.startsWith("http") &&
        SUPABASE_ANON_KEY.length > 40 &&
        !SUPABASE_URL.includes("PASTE_") &&
        !SUPABASE_ANON_KEY.includes("PASTE_")
      );
    }

    function getSupabase(){
      if (!globalEnabled()) return null;
      if (sb) return sb;
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return sb;
    }

    async function getSession(){
      const client = getSupabase();
      if (!client) return null;
      const { data } = await client.auth.getSession();
      return data?.session || null;
    }

    async function getAuthUser(){
      const s = await getSession();
      return s?.user || null;
    }

    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function safeInt(v){ return Math.max(0, Math.floor(Number(v || 0))); }

    /***********************
     * ROUTING STATE
     * - We force:
     *   1) Auth Gate BEFORE menu
     *   2) Username creation after first login if missing
     ***********************/
    async function boot(){
      // Always route via auth state.
      const user = await getAuthUser();
      if (!user){
        loadAuthGate();     // forced
        return;
      }

      const prof = await fetchMyProfile();
      if (!prof?.username){
        loadUsernameGate(); // forced
        return;
      }

      // Auth + username ready
      loadMainMenu();       // unchanged theme
    }

    async function fetchMyProfile(){
      const client = getSupabase();
      const user = await getAuthUser();
      if (!client || !user) return null;

      const { data, error } = await client
        .from("profiles")
        .select("user_id, username")
        .eq("user_id", user.id)
        .maybeSingle();

      if (error) console.warn("fetchMyProfile error", error);
      return data || null;
    }

    async function upsertMyUsername(username){
      const client = getSupabase();
      const user = await getAuthUser();
      if (!client || !user) return { ok:false, msg:"Not logged in." };

      const u = sanitizeUsername(username);
      if (!u) return { ok:false, msg:"Invalid username." };

      const { error } = await client
        .from("profiles")
        .upsert({ user_id: user.id, username: u }, { onConflict: "user_id" });

      if (error){
        // Likely duplicate username unique violation
        console.warn("upsertMyUsername error", error);
        return { ok:false, msg:"That username is taken. Try another." };
      }
      return { ok:true, msg:"Username saved." };
    }

    function sanitizeUsername(u){
      u = String(u || "").trim();
      u = u.replace(/\s+/g," ");
      u = u.replace(/[^\w\s\-\.]/g,""); // letters/numbers/_/-/.
      u = u.slice(0, 18);
      return u;
    }

    /***********************
     * GLOBAL SCORES API
     * - one row per user per mode (UNIQUE user_id,mode)
     * - updates only if score is higher
     ***********************/
    async function submitBestScore(mode, score){
      const client = getSupabase();
      const user = await getAuthUser();
      if (!client || !user) return false;
      if (!MODES.includes(mode)) return false;

      const s = safeInt(score);
      if (!s) return false;

      // read existing
      const { data: existing, error: readErr } = await client
        .from("scores")
        .select("score")
        .eq("user_id", user.id)
        .eq("mode", mode)
        .maybeSingle();

      if (readErr) console.warn("submitBestScore readErr", readErr);

      const prev = safeInt(existing?.score || 0);
      if (s <= prev) return false;

      // upsert best
      const { error: upsertErr } = await client
        .from("scores")
        .upsert(
          { user_id: user.id, mode, score: s, updated_at: new Date().toISOString() },
          { onConflict: "user_id,mode" }
        );

      if (upsertErr){
        console.warn("submitBestScore upsertErr", upsertErr);
        return false;
      }
      return true;
    }

    async function fetchGlobalTop25(mode){
      const client = getSupabase();
      if (!client) return [];
      if (!MODES.includes(mode)) return [];

      const { data, error } = await client
        .from("scores")
        .select("score, user_id, updated_at, profiles:profiles(username)")
        .eq("mode", mode)
        .order("score", { ascending:false })
        .order("updated_at", { ascending:false })
        .limit(25);

      if (error){
        console.warn("fetchGlobalTop25 error", error);
        return [];
      }

      return (data || []).map(r => ({
        user_id: r.user_id,
        username: r?.profiles?.username || "â€”",
        score: safeInt(r.score)
      }));
    }

    async function fetchGlobalMyRank(mode){
      const client = getSupabase();
      const user = await getAuthUser();
      if (!client || !user) return null;
      if (!MODES.includes(mode)) return null;

      const { data: me, error: meErr } = await client
        .from("scores")
        .select("score")
        .eq("user_id", user.id)
        .eq("mode", mode)
        .maybeSingle();

      if (meErr){
        console.warn("fetchGlobalMyRank meErr", meErr);
        return null;
      }

      const myScore = safeInt(me?.score || 0);
      if (!myScore) return null;

      const { count, error: countErr } = await client
        .from("scores")
        .select("id", { count:"exact", head:true })
        .eq("mode", mode)
        .gt("score", myScore);

      if (countErr){
        console.warn("fetchGlobalMyRank countErr", countErr);
        return { rank:null, score: myScore };
      }

      return { rank: (count || 0) + 1, score: myScore };
    }
<script>
/**************************************
 * AUTH + USER ROUTING (FORCED)
 **************************************/

let currentUser = null;
let currentProfile = null;

/* ---------- ENTRY POINT ---------- */
window.addEventListener("load", async () => {
  await resolveAuthState();
});

/* ---------- AUTH STATE ---------- */
async function resolveAuthState() {
  const { data } = await supabase.auth.getSession();
  currentUser = data?.session?.user || null;

  if (!currentUser) {
    renderAuthGate();
    return;
  }

  await loadProfile();

  if (!currentProfile || !currentProfile.username) {
    renderUsernameGate();
    return;
  }

  loadMainMenu(); // EXISTING MENU (unchanged)
}

/* ---------- PROFILE ---------- */
async function loadProfile() {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("user_id", currentUser.id)
    .single();

  currentProfile = data || null;
}

/**************************************
 * AUTH GATE (LOGIN / CREATE ACCOUNT)
 **************************************/
function renderAuthGate() {
  const c = document.getElementById("game-container");
  c.innerHTML = `
    <div class="menu-screen">
      <h1>GRIDRUN</h1>

      <input id="authEmail" placeholder="Email" />
      <input id="authPass" type="password" placeholder="Password" />

      <button onclick="login()">Login</button>
      <button onclick="createAccount()">Create Account</button>
    </div>
  `;
}

async function login() {
  const email = document.getElementById("authEmail").value.trim();
  const password = document.getElementById("authPass").value.trim();

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);

  await resolveAuthState();
}

async function createAccount() {
  const email = document.getElementById("authEmail").value.trim();
  const password = document.getElementById("authPass").value.trim();

  const { error } = await supabase.auth.signUp({ email, password });
  if (error) return alert(error.message);

  alert("Account created. Please log in.");
}

/**************************************
 * USERNAME GATE (FORCED)
 **************************************/
function renderUsernameGate() {
  const c = document.getElementById("game-container");
  c.innerHTML = `
    <div class="menu-screen">
      <h1>Create Username</h1>
      <p>This will appear on leaderboards</p>

      <input id="usernameInput" maxlength="16" placeholder="Username" />
      <button onclick="saveUsername()">Continue</button>
    </div>
  `;
}

async function saveUsername() {
  const username = document.getElementById("usernameInput").value.trim();

  if (username.length < 3) {
    alert("Username must be at least 3 characters");
    return;
  }

  const { error } = await supabase.from("profiles").upsert({
    user_id: currentUser.id,
    username
  });

  if (error) {
    alert("Username already taken");
    return;
  }

  await loadProfile();
  loadMainMenu();
}

/**************************************
 * ACCOUNT SCREEN (LOGOUT)
 **************************************/
function loadAccount() {
  const c = document.getElementById("game-container");
  c.innerHTML = `
    <div class="menu-screen">
      <h1>Account</h1>

      <p><b>Email:</b> ${currentUser.email}</p>
      <p><b>Username:</b> ${currentProfile.username}</p>

      <button onclick="logout()">Logout</button>
      <button onclick="loadMainMenu()">Back</button>
    </div>
  `;
}

async function logout() {
  await supabase.auth.signOut();
  currentUser = null;
  currentProfile = null;
  renderAuthGate();
}

/**************************************
 * HELPERS (USED LATER)
 **************************************/
function getUserId() {
  return currentUser?.id || null;
}

function getUsername() {
  return currentProfile?.username || null;
}
</script>
