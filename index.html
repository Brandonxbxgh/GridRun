<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no" />
  <title>GRIDRUN</title>
  <style>
    :root{
      --bgA:#1a1c30;
      --bgB:#292942;
      --accentA:#ff5733;
      --accentB:#ff8b3d;
      --glass:rgba(0,0,0,0.22);
      --glass2:rgba(0,0,0,0.30);
      --stroke:rgba(255,255,255,0.12);
      --stroke2:rgba(255,255,255,0.18);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.72);
      --muted2:rgba(255,255,255,0.58);
    }

    body{
      margin:0;padding:0;
      font-family:Verdana,sans-serif;
      background:linear-gradient(135deg,var(--bgA),var(--bgB),var(--bgA));
      animation:backgroundMove 10s infinite alternate;
      height:100vh; overflow:hidden; color:white;
    }
    @keyframes backgroundMove {0%{background-position:0% 50%}100%{background-position:100% 50%}}

    #game-container{display:flex;justify-content:center;align-items:center;height:100%;text-align:center;}
    #phaser-container{display:none;width:100%;height:100%;justify-content:center;align-items:center;}
    canvas{display:block;margin:0 auto;}

    h1{font-size:3rem;font-weight:bold;color:#fff;text-shadow:0 0 20px var(--accentA),0 0 30px var(--accentA); margin:0 0 8px 0;}
    p{font-size:18px;margin:10px 0;}
    button{
      margin:8px;padding:15px 30px;font-size:1rem;font-weight:bold;color:white;
      background:linear-gradient(45deg,var(--accentA),var(--accentB));
      border:none;border-radius:50px;cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.4),0 0 15px rgba(255,87,51,.7);
      transition:transform .2s,box-shadow .3s,opacity .2s;
    }
    button:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.4),0 0 25px rgba(255,110,60,1)}
    button:active{transform:translateY(2px);box-shadow:0 2px 5px rgba(0,0,0,.3),0 0 10px rgba(255,79,40,.9)}
    button:disabled{opacity:.35;cursor:not-allowed;filter:grayscale(.25);box-shadow:none;transform:none}

    .menu-screen{
      display:flex;flex-direction:column;align-items:center;gap:10px;
      padding:20px;max-width:560px;width:100%;
    }

    .subhead{
      font-size:14px;
      color:var(--muted);
      margin:0 0 14px 0;
      line-height:1.4;
      max-width:520px;
    }

    .panel{
      width:100%;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 26px rgba(0,0,0,0.28);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .panelTitle strong{
      font-size:14px;
      color:var(--text);
      letter-spacing:0.3px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,0.25);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .pill b{color:#fff; font-weight:700;}

    .toggle-row{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.12);
    }
    .toggle-row span{font-size:14px;opacity:0.95}
    .small-note{font-size:12px;opacity:0.75;max-width:520px;line-height:1.35}

    /* Leaderboards UI */
    .tabs{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      margin:10px 0 12px 0;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(0,0,0,0.28);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      transition:transform .15s, border-color .2s, background .2s, color .2s;
      user-select:none;
    }
    .tab:hover{ transform:translateY(-2px); border-color:rgba(255,255,255,0.22); }
    .tab.active{
      background:linear-gradient(45deg,rgba(255,87,51,0.35),rgba(255,139,61,0.28));
      border-color:rgba(255,140,80,0.55);
      color:#fff;
      box-shadow:0 0 20px rgba(255,110,60,0.25);
    }

    .lbWrap{
      width:100%;
      max-height:52vh;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,0.22);
    }
    .lbHeader, .lbRow{
      display:grid;
      grid-template-columns: 70px 1fr 110px;
      gap:10px;
      align-items:center;
      padding:12px 12px;
    }
    .lbHeader{
      position:sticky;
      top:0;
      z-index:2;
      background:rgba(0,0,0,0.45);
      border-bottom:1px solid rgba(255,255,255,0.10);
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.3px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .lbRow{
      border-bottom:1px solid rgba(255,255,255,0.08);
      font-size:14px;
      color:var(--text);
    }
    .lbRow:last-child{border-bottom:none;}
    .rank{
      font-weight:900;
      color:#fff;
      opacity:0.92;
    }
    .name{
      display:flex;
      align-items:center;
      gap:10px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.10);
      color:var(--muted);
      white-space:nowrap;
    }
    .score{
      text-align:right;
      font-weight:900;
      color:#fff;
      letter-spacing:0.3px;
    }
    .me{
      background:linear-gradient(90deg,rgba(255,87,51,0.16),rgba(0,0,0,0));
      border-left:3px solid rgba(255,87,51,0.65);
    }
    .hint{
      font-size:12px;
      color:var(--muted2);
      line-height:1.4;
      margin-top:10px;
    }

    /* Smooth scroll on iOS */
    .lbWrap{ -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>
  <!-- NOTE: We do NOT render the main menu in HTML anymore to avoid flashes.
       JS will force Auth Gate on boot. -->
  <div id="game-container"></div>
  <div id="phaser-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <script>
    /***********************
     * AUTH (local, username-only)
     * - safe now, upgradeable later
     ***********************/
    const AUTH_KEY = "gridrun_auth_v1"; // { username: "Name" } or null

    function getActiveUser(){
      try{
        const raw = localStorage.getItem(AUTH_KEY);
        if (!raw) return null;
        const a = JSON.parse(raw);
        const u = String(a?.username || "").trim();
        if (!u) return null;
        return u;
      }catch{ return null; }
    }

    function setActiveUser(username){
      const u = String(username || "").trim();
      if (!u) return;
      localStorage.setItem(AUTH_KEY, JSON.stringify({ username: u }));
    }

    function clearActiveUser(){
      localStorage.removeItem(AUTH_KEY);
    }

    function sanitizeUsername(u){
      u = String(u || "").trim();
      u = u.replace(/\s+/g," ");
      u = u.replace(/[^\w\s\-\.]/g,""); // keep letters/numbers/_/-/.
      u = u.slice(0, 18);
      return u;
    }

    /***********************
     * SAVE (progress + settings)
     * - per-user progress (so leaderboards make sense)
     ***********************/
    const SAVE_KEY_LEGACY = "gridrun_dom_progress_v2";
    const SETTINGS_KEY = "gridrun_audio_settings_v1";

    function progressKey(){
      const u = getActiveUser();
      return u ? `gridrun_progress_user_${u.toLowerCase()}` : SAVE_KEY_LEGACY;
    }

    function defaultProgress() {
      return {
        worldsUnlocked: 1,
        levelsUnlocked: [1, 0, 0],
        bestScores: [
          [0,0,0,0,0],
          [0,0,0,0,0],
          [0,0,0,0,0],
        ],
        endlessBest: 0
      };
    }

    function loadProgress() {
      try {
        // migrate legacy -> user key if user exists
        const u = getActiveUser();
        const key = progressKey();

        // If user has no progress yet, but legacy exists, copy once.
        if (u && !localStorage.getItem(key) && localStorage.getItem(SAVE_KEY_LEGACY)){
          localStorage.setItem(key, localStorage.getItem(SAVE_KEY_LEGACY));
        }

        const raw = localStorage.getItem(key);
        if (!raw) return defaultProgress();
        const p = JSON.parse(raw);
        const d = defaultProgress();
        const out = { ...d, ...p };

        if (!Array.isArray(out.levelsUnlocked) || out.levelsUnlocked.length !== 3) out.levelsUnlocked = d.levelsUnlocked.slice();
        if (!Array.isArray(out.bestScores) || out.bestScores.length !== 3) out.bestScores = d.bestScores.map(r=>r.slice());

        for (let w=0; w<3; w++){
          if (!Array.isArray(out.bestScores[w]) || out.bestScores[w].length !== 5) out.bestScores[w] = [0,0,0,0,0];
          for (let l=0; l<5; l++) out.bestScores[w][l] = Math.max(0, Math.floor(out.bestScores[w][l] || 0));
        }

        out.worldsUnlocked = Math.max(1, Math.min(3, Math.floor(out.worldsUnlocked || 1)));
        out.levelsUnlocked = out.levelsUnlocked.map((x)=>Math.max(0, Math.min(5, Math.floor(x || 0))));
        out.endlessBest = Math.max(0, Math.floor(out.endlessBest || 0));
        return out;
      } catch {
        return defaultProgress();
      }
    }

    function saveProgress(p) { localStorage.setItem(progressKey(), JSON.stringify(p)); }
    let progress = loadProgress();

    function defaultSettings(){
      return {
        menuMusic: true,
        gameplayMusic: true,
        sfx: true,
        volumeMusic: 0.75,
        volumeSfx: 0.85
      };
    }

    function loadSettingsState(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) return defaultSettings();
        const s = { ...defaultSettings(), ...JSON.parse(raw) };
        s.menuMusic = !!s.menuMusic;
        s.gameplayMusic = !!s.gameplayMusic;
        s.sfx = !!s.sfx;
        s.volumeMusic = Math.max(0, Math.min(1, Number(s.volumeMusic ?? 0.75)));
        s.volumeSfx = Math.max(0, Math.min(1, Number(s.volumeSfx ?? 0.85)));
        return s;
      }catch{
        return defaultSettings();
      }
    }

    function saveSettingsState(s){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    }

    let settings = loadSettingsState();

    /***********************
     * LOCAL LEADERBOARDS
     * - stored per browser for now
     ***********************/
    const LB_KEY = "gridrun_leaderboards_local_v1";
    function defaultLeaderboards(){
      return { users: {} }; // users[usernameLower] = { username, endlessBest, campaignTotal, worldTotals:[w1,w2,w3], updatedAt }
    }
    function loadLeaderboardsState(){
      try{
        const raw = localStorage.getItem(LB_KEY);
        if (!raw) return defaultLeaderboards();
        const s = { ...defaultLeaderboards(), ...JSON.parse(raw) };
        if (!s.users || typeof s.users !== "object") s.users = {};
        return s;
      }catch{ return defaultLeaderboards(); }
    }
    function saveLeaderboardsState(s){
      localStorage.setItem(LB_KEY, JSON.stringify(s));
    }

    function sumCampaignTotals(p){
      const worldTotals = [0,0,0];
      for (let w=0; w<3; w++){
        let t=0;
        for (let l=0; l<5; l++) t += Math.max(0, Math.floor(p.bestScores?.[w]?.[l] || 0));
        worldTotals[w]=t;
      }
      const campaignTotal = worldTotals[0] + worldTotals[1] + worldTotals[2];
      return { campaignTotal, worldTotals };
    }

    function updateLeaderboardsFromProgress(){
      const u = getActiveUser();
      if (!u) return; // require login to post scores
      const username = u;
      const k = username.toLowerCase();
      const lb = loadLeaderboardsState();
      const p = loadProgress();
      const totals = sumCampaignTotals(p);

      const prev = lb.users[k] || { username, endlessBest:0, campaignTotal:0, worldTotals:[0,0,0], updatedAt:0 };

      lb.users[k] = {
        username,
        endlessBest: Math.max(prev.endlessBest || 0, Math.floor(p.endlessBest || 0)),
        campaignTotal: Math.max(prev.campaignTotal || 0, Math.floor(totals.campaignTotal || 0)),
        worldTotals: [
          Math.max(prev.worldTotals?.[0] || 0, totals.worldTotals[0]),
          Math.max(prev.worldTotals?.[1] || 0, totals.worldTotals[1]),
          Math.max(prev.worldTotals?.[2] || 0, totals.worldTotals[2]),
        ],
        updatedAt: Date.now()
      };

      saveLeaderboardsState(lb);
    }

    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

    /***********************
     * SIMPLE MENU AUDIO (HTMLAudioElement)
     ***********************/
    const MENU_MUSIC_SRC = "audio/menu.mp3"; // optional
    let menuMusic = null;

    function ensureMenuMusic(){
      if (!menuMusic){
        menuMusic = new Audio(MENU_MUSIC_SRC);
        menuMusic.loop = true;
        menuMusic.volume = settings.volumeMusic;
      }
    }
    function startMenuMusic(){
      ensureMenuMusic();
      if (!settings.menuMusic) return;
      menuMusic.volume = settings.volumeMusic;
      menuMusic.play().catch(()=>{});
    }
    function stopMenuMusic(){
      if (!menuMusic) return;
      menuMusic.pause();
      menuMusic.currentTime = 0;
    }
    function updateMenuMusicState(){
      ensureMenuMusic();
      menuMusic.volume = settings.volumeMusic;
      if (settings.menuMusic) startMenuMusic();
      else stopMenuMusic();
    }

    /***********************
     * WORLD THEMES (menus)
     ***********************/
    const worlds = [
      { name: "Neon Bliss", description: "Lively neon glow. Learn the flow." },
      { name: "Techno Abyss", description: "Icy pulses. Faster and denser." },
      { name: "Astral Surge", description: "Cosmic chaos. Hazards online." },
    ];

    /***********************
     * LEVEL TIMES + TIER TARGETS
     ***********************/
    const levelTimes = [
      [30, 40, 50, 60, 70],    // World 1
      [45, 60, 75, 90, 100],   // World 2
      [60, 80, 95, 105, 115],  // World 3
    ];

    const TIER_MODEL = {
      pps: 7,
      streakEvery: 12,
      streakBonus: 55,
      expectedNearPer10s: [0.45, 0.70, 0.90],
      expectedNearPoints: 18,
      expectedAvgCombo: [1.18, 1.30, 1.45],
      expectedDodgePer10s: [1.10, 1.35, 1.60],
      expectedDodgePoints: 9,
      clearBonusBase: 220
    };

    function computeTierTargets(worldIdx, levelIdx){
      const t = levelTimes[worldIdx][levelIdx];
      const survival = t * TIER_MODEL.pps;
      const streaks = Math.floor(t / TIER_MODEL.streakEvery);
      const streakScore = streaks * TIER_MODEL.streakBonus;

      const expectedNear = Math.floor((t/10) * TIER_MODEL.expectedNearPer10s[worldIdx]);
      const nearScore = expectedNear * TIER_MODEL.expectedNearPoints * TIER_MODEL.expectedAvgCombo[worldIdx];

      const expectedDodge = Math.floor((t/10) * TIER_MODEL.expectedDodgePer10s[worldIdx]);
      const dodgeScore = expectedDodge * TIER_MODEL.expectedDodgePoints;

      const clearBonus = TIER_MODEL.clearBonusBase + worldIdx*60 + levelIdx*35;
      const expected = survival + streakScore + dodgeScore + nearScore + clearBonus;

      const bronze = Math.floor(expected * (0.78 + 0.015*levelIdx));
      const silver = Math.floor(expected * (0.98 + 0.02*levelIdx));
      const gold   = Math.floor(expected * (1.18 + 0.03*levelIdx));
      return { time: t, scores: { bronze, silver, gold } };
    }
    function levelData(worldIdx, levelIdx){ return computeTierTargets(worldIdx, levelIdx); }

    /***********************
     * MENUS
     ***********************/
    function showMenus(){
      document.getElementById("phaser-container").style.display = "none";
      document.getElementById("game-container").style.display = "flex";
      startMenuMusic();
    }
    function showGameplay(){
      document.getElementById("game-container").style.display = "none";
      document.getElementById("phaser-container").style.display = "flex";
      stopMenuMusic();
    }

    // MAIN MENU: ACCOUNT button ALWAYS (never shows LOGIN)
    // NOTE: main menu is only reachable after login; loadAuthGate is forced on boot.
    function loadMainMenu(){
      startMenuMusic();
      const container = document.getElementById("game-container");

      container.innerHTML = `
        <div class="menu-screen" id="main-menu">
          <h1>GRIDRUN</h1>
          <p class="subhead">Fast. Skill-based. Survive the grid and climb the ranks.</p>
          <button onclick="loadModeSelect()">PLAY</button>
          <button onclick="loadAccount()">ACCOUNT</button>
          <button onclick="loadLeaderboards()">LEADERBOARDS</button>
          <button onclick="loadHowTo()">HOW TO PLAY</button>
          <button onclick="loadSettings()">SETTINGS</button>
        </div>
      `;
    }

    function loadModeSelect() {
      startMenuMusic();
      const container = document.getElementById("game-container");
      container.innerHTML = `
        <div class="menu-screen">
          <h1>Select Mode</h1>
          <div class="panel">
            <div class="panelTitle">
              <strong>Choose your run</strong>
              <span class="pill">Tip: <b>Campaign</b> unlocks Worlds</span>
            </div>
            <button onclick="loadCampaignMode()">Campaign</button>
            <button onclick="loadEndlessIntro()">Endless</button>
          </div>
          <button onclick="loadMainMenu()">Back</button>
        </div>
      `;
    }

    function loadCampaignMode() {
      startMenuMusic();
      progress = loadProgress();
      const container = document.getElementById("game-container");
      const worldButtons = worlds.map((world, i) => `
        <button onclick="loadWorld(${i + 1})" ${progress.worldsUnlocked > i ? '' : 'disabled'}>
          ${progress.worldsUnlocked > i ? world.name : 'Locked'}
        </button>
      `).join("");

      container.innerHTML = `
        <div class="menu-screen">
          <h1>Campaign</h1>
          <p class="subhead">Survive each level to unlock the next. Your best scores build your Campaign Total.</p>
          <div class="panel">
            <div class="panelTitle"><strong>Select a World</strong><span class="pill">Unlocked: <b>${progress.worldsUnlocked}/3</b></span></div>
            ${worldButtons}
          </div>
          <button onclick="loadModeSelect()">Back</button>
        </div>
      `;
    }

    function loadWorld(worldNumber) {
      startMenuMusic();
      progress = loadProgress();
      const container = document.getElementById("game-container");
      const worldIdx = worldNumber - 1;
      const levelsUnlocked = progress.levelsUnlocked[worldIdx] || 0;

      const levelButtons = Array.from({ length: 5 }, (_, i) => {
        const unlocked = i < levelsUnlocked;
        const best = progress.bestScores[worldIdx]?.[i] || 0;
        const ld = levelData(worldIdx, i);
        return `
          <button onclick="loadLevelIntro(${worldNumber}, ${i + 1})" ${unlocked ? '' : 'disabled'}>
            ${unlocked ? `Level ${i + 1} • ${ld.time}s • Best: ${best}` : 'Locked'}
          </button>
        `;
      }).join("");

      container.innerHTML = `
        <div class="menu-screen">
          <h1>${worlds[worldIdx].name}</h1>
          <p class="subhead">${worlds[worldIdx].description}</p>
          <div class="panel">
            <div class="panelTitle"><strong>Levels</strong><span class="pill">Unlocked: <b>${levelsUnlocked}/5</b></span></div>
            ${levelButtons}
          </div>
          <button onclick="loadCampaignMode()">Back</button>
        </div>
      `;
    }

    function loadLevelIntro(worldNumber, levelNumber) {
      startMenuMusic();
      progress = loadProgress();
      const container = document.getElementById("game-container");
      const w = worldNumber - 1;
      const l = levelNumber - 1;
      const ld = levelData(w, l);
      const best = progress.bestScores[w]?.[l] || 0;

      container.innerHTML = `
        <div class="menu-screen">
          <h1>Level ${levelNumber}</h1>
          <p class="subhead">${worlds[w].name}</p>

          <div class="panel">
            <div class="panelTitle"><strong>Objective</strong><span class="pill">Survive: <b>${ld.time}s</b></span></div>
            <p style="margin:6px 0 0 0; font-size:14px; color:rgba(255,255,255,0.85);">
              Stay alive until the timer hits zero. More points = better tier.
            </p>
            <div style="height:10px"></div>
            <div class="panelTitle"><strong>Your Best</strong><span class="pill"><b>${best}</b></span></div>
            <div style="height:10px"></div>
            <div class="panelTitle"><strong>Performance Tiers</strong><span class="pill">Targets</span></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:8px">
              <span class="pill">Bronze <b>${ld.scores.bronze}</b></span>
              <span class="pill">Silver <b>${ld.scores.silver}</b></span>
              <span class="pill">Gold <b>${ld.scores.gold}</b></span>
            </div>
          </div>

          <button onclick="playLevel(${worldNumber}, ${levelNumber})">Start</button>
          <button onclick="loadWorld(${worldNumber})">Back</button>
        </div>
      `;
    }

    function loadEndlessIntro(){
      startMenuMusic();
      progress = loadProgress();
      const container = document.getElementById("game-container");
      container.innerHTML = `
        <div class="menu-screen">
          <h1>Endless</h1>
          <p class="subhead">Difficulty ramps from <b>W1L1</b> → <b>W3L5</b> over ~120s, then plateaus.</p>
          <div class="panel">
            <div class="panelTitle"><strong>Local Best</strong><span class="pill"><b>${progress.endlessBest}</b></span></div>
            <button onclick="startGameplay({ mode:'endless' })">Start Endless</button>
          </div>
          <button onclick="loadModeSelect()">Back</button>
        </div>
      `;
    }

    function loadSettings(){
      startMenuMusic();
      settings = loadSettingsState();
      const container = document.getElementById("game-container");
      const onOff = (v)=> v ? "ON" : "OFF";
      container.innerHTML = `
        <div class="menu-screen">
          <h1>Settings</h1>
          <div class="panel">
            <div class="toggle-row">
              <span>Menu Music</span>
              <button onclick="toggleSetting('menuMusic')">${onOff(settings.menuMusic)}</button>
            </div>
            <div class="toggle-row">
              <span>Gameplay Music</span>
              <button onclick="toggleSetting('gameplayMusic')">${onOff(settings.gameplayMusic)}</button>
            </div>
            <div class="toggle-row">
              <span>Sound Effects (SFX)</span>
              <button onclick="toggleSetting('sfx')">${onOff(settings.sfx)}</button>
            </div>

            <p class="small-note" style="margin-top:10px">
              Audio is optional. If you don’t add files in <b>/audio/</b>, the game still runs silently.
            </p>
          </div>
          <button onclick="loadMainMenu()">Back</button>
        </div>
      `;
    }

    function toggleSetting(key){
      settings = loadSettingsState();
      settings[key] = !settings[key];
      saveSettingsState(settings);
      updateMenuMusicState();
      if (window.GRIDRUN_AUDIO && typeof window.GRIDRUN_AUDIO.applySettings === "function"){
        window.GRIDRUN_AUDIO.applySettings(settings);
      }
      loadSettings();
    }

    function loadHowTo(){
      startMenuMusic();
      const container = document.getElementById("game-container");
      container.innerHTML = `
        <div class="menu-screen">
          <h1>How To Play</h1>
          <p class="subhead">Everything you need — objective, scoring, worlds, and endless.</p>

          <div class="panel" style="text-align:left;">
            <div class="panelTitle"><strong>Objective</strong><span class="pill">Survive</span></div>
            <p style="margin:6px 0 14px 0; font-size:14px; color:rgba(255,255,255,0.85); line-height:1.45">
              Stay alive inside the grid. In <b>Campaign</b>, you must survive the full timer for each level to clear it and unlock progression.
              In <b>Endless</b>, survive as long as you can while difficulty ramps up.
            </p>

            <div class="panelTitle"><strong>Controls</strong><span class="pill">Touch or WASD</span></div>
            <p style="margin:6px 0 14px 0; font-size:14px; color:rgba(255,255,255,0.85); line-height:1.45">
              <b>Mobile:</b> touch where you want to move — your runner follows.
              <br><b>Desktop:</b> WASD / Arrow keys.
            </p>

            <div class="panelTitle"><strong>Scoring</strong><span class="pill">Climb ranks</span></div>
            <p style="margin:6px 0 0 0; font-size:14px; color:rgba(255,255,255,0.85); line-height:1.45">
              You gain points over time for staying alive, plus bonuses for clean survival and skillful dodges.
              Clearing a level adds a <b>Clear Bonus</b>.
            </p>

            <p class="hint">
              Your <b>Leaderboards</b> scores update automatically when you improve a best score (Campaign or Endless).
            </p>
          </div>

          <button onclick="loadMainMenu()">Back</button>
        </div>
      `;
    }

    /***********************
     * AUTH SCREENS (FORCED BEFORE MENU)
     ***********************/

    // AUTH GATE: 2 options on boot (LOGIN / CREATE ACCOUNT)
    function loadAuthGate(){
      startMenuMusic();
      const container = document.getElementById("game-container");

      container.innerHTML = `
        <div class="menu-screen">
          <h1>GRIDRUN</h1>
          <p class="subhead">You must login or create an account to enter.</p>

          <div class="panel">
            <div class="panelTitle">
              <strong>Account Access</strong>
              <span class="pill">Required</span>
            </div>

            <button onclick="loadLogin()">LOGIN</button>
            <button onclick="loadCreateAccount()">CREATE ACCOUNT</button>

            <p class="hint">
              Login is local for now (username-only). Create Account is a placeholder until global/auth is integrated.
            </p>
          </div>
        </div>
      `;
    }

    // LOGIN screen (local username)
    function loadLogin(){
      startMenuMusic();
      const container = document.getElementById("game-container");
      container.innerHTML = `
        <div class="menu-screen">
          <h1>Login</h1>
          <p class="subhead">Choose a username to enter GRIDRUN.</p>
          <div class="panel" style="text-align:left;">
            <div class="panelTitle"><strong>Username</strong><span class="pill">1–18 chars</span></div>
            <input id="usernameInput" placeholder="Enter username..." autocomplete="nickname"
              style="width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(255,255,255,0.16);
              background:rgba(0,0,0,0.25);color:white;font-size:16px;outline:none;box-sizing:border-box;" />
            <p class="hint">No password yet (local-only). Global accounts come later.</p>
            <button onclick="doLogin()">Confirm</button>
          </div>
          <button onclick="loadAuthGate()">Back</button>
        </div>
      `;
    }

    // CREATE ACCOUNT placeholder screen
    function loadCreateAccount(){
      startMenuMusic();
      const container = document.getElementById("game-container");
      container.innerHTML = `
        <div class="menu-screen">
          <h1>Create Account</h1>
          <p class="subhead">This is a placeholder until global/auth is integrated.</p>

          <div class="panel" style="text-align:left;">
            <div class="panelTitle"><strong>Coming Soon</strong><span class="pill">Global</span></div>
            <p style="margin:6px 0 0 0; font-size:14px; color:rgba(255,255,255,0.85); line-height:1.45">
              For now, use <b>LOGIN</b> with a username to enter the game.
              When global accounts are added, this screen will become email/password signup.
            </p>
          </div>

          <button onclick="loadAuthGate()">Back</button>
        </div>
      `;
    }

    function doLogin(){
      const el = document.getElementById("usernameInput");
      if (!el) return;
      const u = sanitizeUsername(el.value);
      if (!u){
        alert("Please enter a username.");
        return;
      }
      setActiveUser(u);
      // reload user progress & update LB snapshot
      progress = loadProgress();
      updateLeaderboardsFromProgress();
      loadMainMenu(); // now allowed
    }

    function loadAccount(){
      startMenuMusic();
      const u = getActiveUser();
      const container = document.getElementById("game-container");
      if (!u){ loadAuthGate(); return; } // forced auth if not logged in

      progress = loadProgress();
      const totals = sumCampaignTotals(progress);

      container.innerHTML = `
        <div class="menu-screen">
          <h1>Account</h1>
          <p class="subhead">Logged in as <b>${u}</b></p>

          <div class="panel" style="text-align:left;">
            <div class="panelTitle"><strong>Your Stats</strong><span class="pill">Local</span></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:8px">
              <span class="pill">Endless Best <b>${progress.endlessBest}</b></span>
              <span class="pill">Campaign Total <b>${totals.campaignTotal}</b></span>
            </div>

            <div style="height:12px"></div>
            <div class="panelTitle"><strong>Edit Username</strong><span class="pill">renames profile</span></div>
            <input id="usernameEdit" value="${u}" autocomplete="nickname"
              style="width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(255,255,255,0.16);
              background:rgba(0,0,0,0.25);color:white;font-size:16px;outline:none;box-sizing:border-box;" />
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px">
              <button onclick="saveUsernameChange()">Save</button>
              <button onclick="logout()">Logout</button>
            </div>
            <p class="hint">This is local-only for now. Global accounts come later.</p>
          </div>

          <button onclick="loadMainMenu()">Back</button>
        </div>
      `;
    }

    function saveUsernameChange(){
      const el = document.getElementById("usernameEdit");
      if (!el) return;
      const newU = sanitizeUsername(el.value);
      if (!newU){ alert("Invalid username."); return; }

      const oldU = getActiveUser();
      if (!oldU) return;

      // Move progress to new user key (copy old key content)
      const oldKey = `gridrun_progress_user_${oldU.toLowerCase()}`;
      const newKey = `gridrun_progress_user_${newU.toLowerCase()}`;
      const raw = localStorage.getItem(oldKey);
      if (raw) localStorage.setItem(newKey, raw);

      setActiveUser(newU);
      progress = loadProgress();
      updateLeaderboardsFromProgress();
      loadAccount();
    }

    function logout(){
      clearActiveUser();
      progress = loadProgress();
      loadAuthGate(); // forced back to gate
    }

    /***********************
     * LEADERBOARDS (polished)
     ***********************/
    function buildRanking(metric){
      const lb = loadLeaderboardsState();
      const rows = Object.values(lb.users || {});
      const cleaned = rows
        .filter(r => r && r.username)
        .map(r => ({
          username: r.username,
          endlessBest: Math.floor(r.endlessBest || 0),
          campaignTotal: Math.floor(r.campaignTotal || 0),
          worldTotals: [
            Math.floor(r.worldTotals?.[0] || 0),
            Math.floor(r.worldTotals?.[1] || 0),
            Math.floor(r.worldTotals?.[2] || 0),
          ],
          updatedAt: Math.floor(r.updatedAt || 0)
        }));

      const scoreOf = (r)=>{
        if (metric === "endless") return r.endlessBest;
        if (metric === "campaign") return r.campaignTotal;
        if (metric === "w1") return r.worldTotals[0];
        if (metric === "w2") return r.worldTotals[1];
        if (metric === "w3") return r.worldTotals[2];
        return 0;
      };

      cleaned.sort((a,b)=>{
        const da = scoreOf(a), db = scoreOf(b);
        if (db !== da) return db - da;
        return (b.updatedAt||0) - (a.updatedAt||0);
      });

      return { list: cleaned, scoreOf };
    }

    function renderLeaderboardList(metric){
      const u = getActiveUser();
      const myKey = u ? u.toLowerCase() : null;

      const { list, scoreOf } = buildRanking(metric);
      const top = list.slice(0, 25);

      const header = `
        <div class="lbHeader">
          <div>RANK</div>
          <div>PLAYER</div>
          <div style="text-align:right">SCORE</div>
        </div>
      `;

      const rows = top.map((r, idx)=>{
        const isMe = (myKey && r.username.toLowerCase() === myKey);
        const val = scoreOf(r);
        return `
          <div class="lbRow ${isMe ? "me" : ""}">
            <div class="rank">#${idx+1}</div>
            <div class="name">
              <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.username}</span>
              ${isMe ? `<span class="badge">YOU</span>` : ``}
            </div>
            <div class="score">${val}</div>
          </div>
        `;
      }).join("");

      // find my rank (if logged in)
      let myRankHtml = "";
      if (myKey){
        const i = list.findIndex(r => r.username.toLowerCase() === myKey);
        if (i >= 0){
          const me = list[i];
          myRankHtml = `
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 0 0">
              <span class="pill">Your Rank <b>#${i+1}</b></span>
              <span class="pill">Your Score <b>${scoreOf(me)}</b></span>
            </div>
          `;
        } else {
          myRankHtml = `
            <div class="hint" style="margin-top:10px">
              Play a run to appear here.
            </div>
          `;
        }
      } else {
        myRankHtml = `
          <div class="hint" style="margin-top:10px">
            Login to post scores. You can still view the board.
          </div>
        `;
      }

      return `
        <div class="lbWrap">
          ${header}
          ${rows || `<div style="padding:14px;color:rgba(255,255,255,0.75)">No scores yet.</div>`}
        </div>
        ${myRankHtml}
      `;
    }

    function loadLeaderboards(){
      startMenuMusic();
      updateLeaderboardsFromProgress(); // refresh snapshot for current user
      const container = document.getElementById("game-container");
      const u = getActiveUser();

      const tabs = [
        { key:"endless", label:"Endless" },
        { key:"campaign", label:"Campaign Total" },
        { key:"w1", label:"World 1" },
        { key:"w2", label:"World 2" },
        { key:"w3", label:"World 3" },
      ];

      container.innerHTML = `
        <div class="menu-screen">
          <h1>Leaderboards</h1>
          <p class="subhead">${u ? `Logged in as <b>${u}</b>. Scores update when you beat a personal best.` : `View rankings. Login to post scores.`}</p>

          <div class="panel">
            <div class="panelTitle">
              <strong>Rankings</strong>
              <span class="pill">Top <b>25</b> (local)</span>
            </div>

            <div class="tabs" id="lbTabs">
              ${tabs.map((t,i)=>`<div class="tab ${i===0?"active":""}" onclick="switchLbTab('${t.key}', this)">${t.label}</div>`).join("")}
            </div>

            <div id="lbContent">
              ${renderLeaderboardList("endless")}
            </div>

            <p class="hint">
              Local leaderboards are stored on-device for now. When we add <b>Global Leaderboards</b>, this screen stays — only the data source changes.
            </p>
          </div>

          <button onclick="loadMainMenu()">Back</button>
        </div>
      `;
    }

    function switchLbTab(key, el){
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      el.classList.add("active");
      document.getElementById("lbContent").innerHTML = renderLeaderboardList(key);
    }

    function playLevel(worldNumber, levelNumber) {
      startGameplay({ mode:"campaign", world: worldNumber-1, level: levelNumber-1 });
    }

    /***********************
     * GAME BRIDGE (menus <-> phaser)
     ***********************/
    window.GRIDRUN = {
      completeCampaignLevel: (worldIdx, levelIdx, score) => {
        const p = loadProgress();
        p.bestScores[worldIdx][levelIdx] = Math.max(p.bestScores[worldIdx][levelIdx] || 0, score);

        const currentUnlocked = p.levelsUnlocked[worldIdx] || 0;
        if (currentUnlocked === (levelIdx + 1)) {
          p.levelsUnlocked[worldIdx] = Math.min(5, currentUnlocked + 1);
          if (levelIdx === 4 && worldIdx < 2) {
            p.worldsUnlocked = Math.max(p.worldsUnlocked, worldIdx + 2);
            p.levelsUnlocked[worldIdx + 1] = Math.max(p.levelsUnlocked[worldIdx + 1] || 0, 1);
          }
        }

        saveProgress(p);
        updateLeaderboardsFromProgress();
      },

      setEndlessBest: (score) => {
        const p = loadProgress();
        p.endlessBest = Math.max(p.endlessBest || 0, score);
        saveProgress(p);
        updateLeaderboardsFromProgress();
      },

      getTierTargets: (worldIdx, levelIdx) => levelData(worldIdx, levelIdx).scores,

      backToLevelSelect: (worldIdx) => { showMenus(); loadWorld(worldIdx + 1); },
      backToMainMenu: () => { showMenus(); loadMainMenu(); }
    };

    /***********************
     * PHASER GAMEPLAY
     ***********************/
    let phaserGame = null;

    function startGameplay(payload){
      showGameplay();
      if (!phaserGame) phaserGame = createPhaserGame();
      phaserGame.scene.stop("Results");
      phaserGame.scene.stop("Play");
      phaserGame.scene.start("Play", payload);
    }

    /* ===========
       YOUR FULL PHASER SECTION CONTINUES HERE UNCHANGED
       (I did not modify gameplay at all.)
       =========== */

    function createPhaserGame(){
      const W = 420, H = 760;
      const uiFont = "system-ui,-apple-system,Segoe UI,Roboto,sans-serif";

      // GRID
      const GRID_COLS = 7, GRID_ROWS = 13, TILE = 52;
      const GRID_W = GRID_COLS * TILE, GRID_H = GRID_ROWS * TILE;
      const GRID_X = (W - GRID_W) / 2, GRID_Y = (H - GRID_H) / 2;

      // Movement
      const PLAYER_SPEED = 320;
      const IS_TOUCH = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
      const FOLLOW_RADIUS = 7;
      const FOLLOW_LERP = 0.40;
      const FOLLOW_MAX_SPEED_MULT = 3.0;
      const lerp = (a,b,t)=>a+(b-a)*t;

      // WORLD THEMES + AUDIO keys
      const WORLDS = [
        {
          id:0,
          name:"Neon Bliss",
          subtitle:"Neon pink & cyan. Lively glow.",
          bg: 0x07001a,
          border: 0xff2fd6,
          gridLine: 0x55f7ff,
          glowA: 0xff2fd6,
          glowB: 0x55f7ff,
          player: 0xffffff,
          fx:"sparkle",
          musicKey:"music_w1",
          obstacleStyle:{ palette:[0xff2fd6,0x55f7ff,0xfff06a], shapes:["tri","hex","frame","rect"] },
          hazardHotColumn:{ enabled:true, startAt:10, every:11.5, warn:0.9, active:1.1, alphaWarn:0.22, alphaActive:0.58 }
        },
        {
          id:1,
          name:"Techno Abyss",
          subtitle:"Icy pulses. Faster and denser.",
          bg: 0x00131f,
          border: 0xa8e9ff,
          gridLine: 0x44a3ff,
          glowA: 0xa8e9ff,
          glowB: 0x44a3ff,
          player: 0xe9fbff,
          fx:"pulse",
          musicKey:"music_w2",
          obstacleStyle:{ palette:[0xa8e9ff,0x44a3ff,0xffffff,0x7cffd2], shapes:["bar","plus","rect","frame","hex"] },
          hazardEmp:{ enabled:true, startAt:14, every:12.5, warn:0.9, jam:0.55 }
        },
        {
          id:2,
          name:"Astral Surge",
          subtitle:"Galaxy purples & greens. Glitch storms.",
          bg: 0x050016,
          border: 0xb45cff,
          gridLine: 0x38ffb8,
          glowA: 0xb45cff,
          glowB: 0x38ffb8,
          player: 0xf1e8ff,
          fx:"astral",
          musicKey:"music_w3",
          obstacleStyle:{ palette:[0xb45cff,0x38ffb8,0xff4d7d,0xffd166], shapes:["hex","tri","bar","frame","plus","rect"] },
          boss:{ enabled:true, cycleSeconds:5.7, warnSeconds:1.20, activeSeconds:1.12, thickness:16, warnThickness:6 }
        }
      ];

      /* ---- SNIP WARNING ----
         Your gameplay code continues exactly as you pasted it.
         I’m not rewriting it here again because it will exceed message limits.
         NOTHING in your PlayScene/ResultsScene logic needs to change for this auth gate change.
         ---- SNIP WARNING ---- */

      return new Phaser.Game({
        type: Phaser.AUTO,
        width: W,
        height: H,
        parent: "phaser-container",
        physics: { default:"arcade", arcade:{ debug:false } },
        scene: [PlayScene, ResultsScene]
      });
    }

    // Boot (FORCED AUTH GATE FIRST)
    window.addEventListener("load", () => {
      showMenus();
      loadAuthGate(); // must login/create account before main menu
    });
  </script>
</body>
</html>