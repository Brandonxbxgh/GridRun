<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>GRIDRUN (DEV)</title>

<style>
body{
  margin:0;
  background:linear-gradient(135deg,#1a1c30,#292942);
  color:white;
  font-family:Verdana,sans-serif;
  height:100vh;
  overflow:hidden;
}
#game-container{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
  text-align:center;
}
.menu{
  display:flex;
  flex-direction:column;
  gap:12px;
  max-width:420px;
  width:100%;
  padding:20px;
}
button{
  padding:14px;
  font-size:16px;
  border:none;
  border-radius:40px;
  background:linear-gradient(45deg,#ff5733,#ff8b3d);
  color:white;
  font-weight:bold;
}
button:disabled{opacity:.4}
input{
  padding:12px;
  font-size:16px;
  width:100%;
  border-radius:12px;
  border:none;
}
.lbRow{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
}
.lbRow.me{font-weight:bold;color:#ff8b3d}
</style>
</head>

<body>
<div id="game-container"></div>

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/*********************************************************
 * SAFETY NET
 *********************************************************/
window.onerror=(m,s,l,c)=>alert("JS ERROR:\n"+m+"\n"+s+":"+l);
window.onunhandledrejection=e=>alert("PROMISE ERROR:\n"+(e.reason?.message||e.reason));

/*********************************************************
 * SUPABASE
 *********************************************************/
const SUPABASE_URL="https://pgoeyzhnrafupqvfrdnn.supabase.co";
const SUPABASE_ANON_KEY="YOUR_KEY_ALREADY_HERE";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/*********************************************************
 * GLOBAL STATE
 *********************************************************/
let currentUser=null;
let profile=null;

/*********************************************************
 * HELPERS
 *********************************************************/
function sanitizeUsername(v){
  return String(v||"").trim().replace(/\s+/g,"_").replace(/[^a-z0-9_]/gi,"").slice(0,18);
}
function show(html){
  document.getElementById("game-container").innerHTML=html;
}

/*********************************************************
 * AUTH
 *********************************************************/
async function initAuth(){
  const {data}=await supabase.auth.getSession();
  currentUser=data?.session?.user||null;

  supabase.auth.onAuthStateChange(async(_,session)=>{
    currentUser=session?.user||null;
    if(currentUser){await ensureProfile();loadMainMenu();}
    else loadAuthGate();
  });

  if(!currentUser) loadAuthGate();
  else{await ensureProfile();loadMainMenu();}
}

async function ensureProfile(){
  const {data}=await supabase.from("profiles").select("*").eq("id",currentUser.id).maybeSingle();
  if(data){profile=data;return;}
  const uname=sanitizeUsername("player_"+currentUser.id.slice(0,4));
  await supabase.from("profiles").insert({id:currentUser.id,username:uname});
  const res=await supabase.from("profiles").select("*").eq("id",currentUser.id).single();
  profile=res.data;
}

/*********************************************************
 * AUTH UI
 *********************************************************/
function loadAuthGate(){
  show(`
  <div class="menu">
    <h1>GRIDRUN</h1>
    <button onclick="loadLogin()">LOGIN</button>
    <button onclick="loadSignup()">CREATE ACCOUNT</button>
  </div>
  `);
}

function loadLogin(){
  show(`
  <div class="menu">
    <h2>Login</h2>
    <input id="le" placeholder="Email"/>
    <input id="lp" type="password" placeholder="Password"/>
    <button onclick="doLogin()">Confirm</button>
    <button onclick="loadAuthGate()">Back</button>
  </div>
  `);
}

async function doLogin(){
  const email=le.value,password=lp.value;
  const {error}=await supabase.auth.signInWithPassword({email,password});
  if(error) return alert(error.message);
}

function loadSignup(){
  show(`
  <div class="menu">
    <h2>Create</h2>
    <input id="se" placeholder="Email"/>
    <input id="su" placeholder="Username"/>
    <input id="sp" type="password" placeholder="Password"/>
    <button onclick="doSignup()">Create</button>
    <button onclick="loadAuthGate()">Back</button>
  </div>
  `);
}

async function doSignup(){
  const email=se.value,password=sp.value,username=sanitizeUsername(su.value);
  const {data,error}=await supabase.auth.signUp({email,password});
  if(error) return alert(error.message);
  await supabase.from("profiles").insert({id:data.user.id,username});
}

async function logout(){
  await supabase.auth.signOut();
}

/*********************************************************
 * MAIN MENU
 *********************************************************/
function loadMainMenu(){
  show(`
  <div class="menu">
    <h1>GRIDRUN</h1>
    <button onclick="loadEndless()">ENDLESS</button>
    <button onclick="loadLeaderboards()">LEADERBOARDS</button>
    <button onclick="loadAccount()">ACCOUNT</button>
    <button onclick="logout()">LOGOUT</button>
  </div>
  `);
}

/*********************************************************
 * ENDLESS MODE (GLOBAL SCORE)
 *********************************************************/
let endlessBest=0;

async function loadEndless(){
  show(`
  <div class="menu">
    <h2>Endless</h2>
    <p>Best: ${endlessBest}</p>
    <button onclick="finishEndless()">Finish Run (+${Math.floor(Math.random()*1000)})</button>
    <button onclick="loadMainMenu()">Back</button>
  </div>
  `);
}

async function finishEndless(){
  const score=Math.floor(Math.random()*1000);
  endlessBest=Math.max(endlessBest,score);

  await supabase.from("scores").upsert({
    user_id:currentUser.id,
    mode:"endless",
    score:endlessBest
  },{onConflict:"user_id,mode"});

  loadEndless();
}

/*********************************************************
 * LEADERBOARDS
 *********************************************************/
async function loadLeaderboards(){
  const {data}=await supabase
    .from("scores")
    .select("user_id,score")
    .eq("mode","endless")
    .order("score",{ascending:false})
    .limit(25);

  let rows="";
  for(let i=0;i<(data||[]).length;i++){
    const r=data[i];
    const {data:p}=await supabase.from("profiles").select("username").eq("id",r.user_id).single();
    rows+=`<div class="lbRow ${r.user_id===currentUser.id?"me":""}">
      <div>#${i+1}</div><div>${p?.username||"?"}</div><div>${r.score}</div>
    </div>`;
  }

  show(`
  <div class="menu">
    <h2>Leaderboard</h2>
    ${rows||"<p>No scores yet</p>"}
    <button onclick="loadMainMenu()">Back</button>
  </div>
  `);
}

/*********************************************************
 * ACCOUNT
 *********************************************************/
function loadAccount(){
  show(`
  <div class="menu">
    <h2>Account</h2>
    <p>${profile.username}</p>
    <input id="ue" value="${profile.username}"/>
    <button onclick="saveUsername()">Save</button>
    <button onclick="loadMainMenu()">Back</button>
  </div>
  `);
}

async function saveUsername(){
  const u=sanitizeUsername(ue.value);
  const {error}=await supabase.from("profiles").update({username:u}).eq("id",currentUser.id);
  if(error) return alert("Username taken");
  await ensureProfile();
  loadAccount();
}

/*********************************************************
 * BOOT
 *********************************************************/
window.addEventListener("load",initAuth);
</script>
</body>
</html>